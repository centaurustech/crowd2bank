!function(root,factory){"object"==typeof exports&&"function"==typeof require?module.exports=factory(require("backbone")):"function"==typeof define&&define.amd?define(["backbone"],function(Backbone){return factory(Backbone||root.Backbone)}):factory(Backbone)}(this,function(Backbone){function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function isObject(item){return item===Object(item)}function contains(array,item){for(var i=array.length;i--;)if(array[i]===item)return!0;return!1}function extend(obj,props){for(var key in props)obj[key]=props[key];return obj}return Backbone.LocalStorage=window.Store=function(name,serializer){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=name,this.serializer=serializer||{serialize:function(item){return isObject(item)?JSON.stringify(item):item},deserialize:function(data){return data&&JSON.parse(data)}};var store=this.localStorage().getItem(this.name);this.records=store&&store.split(",")||[]},extend(Backbone.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(model){return model.id||(model.id=guid(),model.set(model.idAttribute,model.id)),this.localStorage().setItem(this._itemName(model.id),this.serializer.serialize(model)),this.records.push(model.id.toString()),this.save(),this.find(model)!==!1},update:function(model){this.localStorage().setItem(this._itemName(model.id),this.serializer.serialize(model));var modelId=model.id.toString();return contains(this.records,modelId)||(this.records.push(modelId),this.save()),this.find(model)!==!1},find:function(model){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(model.id)))},findAll:function(){for(var id,data,result=[],i=0;i<this.records.length;i++)id=this.records[i],data=this.serializer.deserialize(this.localStorage().getItem(this._itemName(id))),null!=data&&result.push(data);return result},destroy:function(model){this.localStorage().removeItem(this._itemName(model.id));for(var modelId=model.id.toString(),i=0;i<this.records.length;i++)this.records[i]===modelId&&this.records.splice(i,1);return this.save(),model},localStorage:function(){return localStorage},_clear:function(){var local=this.localStorage(),itemRe=new RegExp("^"+this.name+"-");local.removeItem(this.name);for(var k in local)itemRe.test(k)&&local.removeItem(k);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(id){return this.name+"-"+id}}),Backbone.LocalStorage.sync=window.Store.sync=Backbone.localSync=function(method,model,options){var resp,errorMessage,store=model.localStorage||model.collection.localStorage,syncDfd=Backbone.$?Backbone.$.Deferred&&Backbone.$.Deferred():Backbone.Deferred&&Backbone.Deferred();try{switch(method){case"read":resp=void 0!=model.id?store.find(model):store.findAll();break;case"create":resp=store.create(model);break;case"update":resp=store.update(model);break;case"delete":resp=store.destroy(model)}}catch(error){errorMessage=22===error.code&&0===store._storageSize()?"Private browsing is unsupported":error.message}return resp?(options&&options.success&&("0.9.10"===Backbone.VERSION?options.success(model,resp,options):options.success(resp)),syncDfd&&syncDfd.resolve(resp)):(errorMessage=errorMessage?errorMessage:"Record Not Found",options&&options.error&&("0.9.10"===Backbone.VERSION?options.error(model,errorMessage,options):options.error(errorMessage)),syncDfd&&syncDfd.reject(errorMessage)),options&&options.complete&&options.complete(resp),syncDfd&&syncDfd.promise()},Backbone.ajaxSync=Backbone.sync,Backbone.getSyncMethod=function(model){return model.localStorage||model.collection&&model.collection.localStorage?Backbone.localSync:Backbone.ajaxSync},Backbone.sync=function(method,model,options){return Backbone.getSyncMethod(model).apply(this,[method,model,options])},Backbone.LocalStorage});